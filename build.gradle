plugins {
	id 'fabric-loom' version '1.6-SNAPSHOT'
	id 'maven-publish'
	id 'org.jetbrains.kotlin.jvm' version '1.7.20'
}

version = project.mod_version
group = project.maven_group

base {
	archivesName = project.archives_base_name
}

repositories {
	// 常用仓库
	mavenCentral()
	// HexMod 仓库
	maven { url = 'https://maven.blamejared.com' }
	// Fabric Maven 仓库
	maven { url = 'https://maven.fabricmc.net' }
	// Cardinal Components 仓库（由 Ladysnake 维护）
	maven { url = 'https://maven.ladysnake.org/releases' }
}

loom {
	splitEnvironmentSourceSets()
	
	// 允许 Kotlin 文件在 java 目录中
	sourceSets.main.kotlin.srcDirs += 'src/main/java'
	
	mixin {
		useLegacyMixinAp = false
	}

	mods {
		"d-core" {
			sourceSet sourceSets.main
			sourceSet sourceSets.client
		}
	}
}

dependencies {
	// Minecraft 和映射
	minecraft "com.mojang:minecraft:${project.minecraft_version}"
	mappings loom.officialMojangMappings()
	modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"

	// Fabric API
	modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
	
	// Kotlin
	modImplementation "net.fabricmc:fabric-language-kotlin:1.9.4+kotlin.1.8.21"
	
	// HexMod
	modImplementation "at.petra-k.hexcasting:hexcasting-fabric-${project.minecraft_version}:0.11.3"
	
	// Cardinal Components API (用于注册媒体消耗品)
	// 这些是编译时依赖，运行时由 HexMod 提供
	modImplementation "dev.onyxstudios.cardinal-components-api:cardinal-components-item:5.2.1"
	modImplementation "dev.onyxstudios.cardinal-components-api:cardinal-components-base:5.2.1"
}

processResources {
	inputs.property "version", project.version
	inputs.property "minecraft_version", project.minecraft_version
	inputs.property "loader_version", project.loader_version
	filteringCharset "UTF-8"

	filesMatching("fabric.mod.json") {
		expand "version": project.version,
				"minecraft_version": project.minecraft_version,
				"loader_version": project.loader_version
	}
}

def targetJavaVersion = 17
tasks.withType(JavaCompile).configureEach {
	it.options.encoding = "UTF-8"
	if (targetJavaVersion >= 10 || JavaVersion.current().isJava10Compatible()) {
		it.options.release = targetJavaVersion
	}
}

compileKotlin {
	kotlinOptions {
		jvmTarget = "17"
	}
}

java {
	def javaVersion = JavaVersion.toVersion(targetJavaVersion)
	sourceCompatibility = javaVersion
	targetCompatibility = javaVersion
	if (JavaVersion.current() < javaVersion) {
		toolchain.languageVersion = JavaLanguageVersion.of(targetJavaVersion)
	}
	archivesBaseName = project.archives_base_name
	withSourcesJar()
}

jar {
	from("LICENSE") {
		rename { "${it}_${project.archivesBaseName}"}
	}
}

publishing {
	publications {
		maven(MavenPublication) {
			from components.java
		}
	}

	repositories {
	}
}

